# 基于socket的tcp即时通讯架构方案
## 一、概述

###  1、 编写目的

+  为项目的系统的开发设计的依据与指导。
+  为参与该项目的编程人员提供依据；
+  为修改、维护提供条件；
+  项目负责人将按计划书的要求布置和控制开发工作全过程；
+  项目质量保证组将按此计划书做阶段性和总结性的质量验证和确认。

### 2、 读者对象

+  项目开发人员，特别是编程人员；
+  软件维护人员；
+  技术管理人员；
+  执行软件质量保证计划的专门人员；
+  参与本项目开发进程各阶段验证、确认以及负责为最后项目验收、鉴定提供相应报告的有关人员。
+  合作各方有关部门的负责人；项目组负责人和全体参加人员。

### 3、 注意事项

+  权限审查：此文档仅供技术部功能组内部使用。
+  保存备份：此文档仅在服务器上作修改，不允许本地备份。
+  该文档采用 markdown 编写规范，建议使用markdownPad或相关编辑工具查看和修改。


## 二、 文档说明

**文档修改纪录**

| **日期**   | **作者**     | **版本** | **备注说明**                   |
|------------|------------  |----------|--------------------------------|
| 2018/6/20  | xiexie1993   | V1.1     | 新建                           |


**当前文档版本**

版本：V1.1


## 三、架构方案（解决方案）

### 0、方案概述


+ 前提条件（即，方案要解决的问题的前提条件）：
    * 基于socket的tcp方式即时通讯
    * 

+ 方案目录：
  * 1、 单服务器架构方案
  * 2、 简单直接分布式架构方案
  * 3、 优化路由分布式架构方案

> 注：
> + 方案2是解决方案1的容量问题，
> + 方案3是优化方案2

### 1、单服务器架构方案

+ 方案描述：
    * 做法: 一台服务器就提供所有的服务。
    * 例子: 用户A与用户B互为好友，A向B发消息，服务器接收到消息时，解析出接收消息的人，直接转发给B即可。
    * 优点: 这种架构最简单
    * 缺点: 当用户数量越来越多时，一台服务器已经无法所有用户的需求，要进行服务扩容，进行分布式部署需改动


~~~
                                                                                
单服务器架构模型示意图:                                                                   
用户A与用户B互为好友，A向B发消息，服务器接收到消息时，解析出接收消息的人，直接转发给B即可

                                 +-------------+                                
                                 | Msg Server  |                                
                                 +-------------+                                
                                /   /   |   \   \                               
                               /   /    |    \   \                              
                              /   /     |     \   \                             
                             / User_B  ...   ...   \                            
                          User_A                  User_N                        
                                                                                
~~~


~~~                                                                             
                                                                                
单服务器版扩展分布式（局限）                                                    
                                 +-------------+                                
                                 | Msg Server  |                                
                                 +-------------+                                
                                /   /   |   \   \                               
                               /   /    |    \   \                              
                              /   /     |     \   \                             
                             / User_B  ...   ...   \                            
                          User_A                  User_N                        
                                        │                                       
                                        │                                       
                                      ╲│╱                                     
                                                                                
                                  平行分布部署                                  
                        （不同服务器的用户之间无法互通）                        
                                                                                
        +-------------+         +-------------+         +-------------+         
        | Msg Server A|         | Msg Server B|   ●●●   | Msg Server N|         
        +-------------+         +-------------+         +-------------+         
      /                       /                                         \       
     /                       /                                           \      
    /                       /                                             \     
   /                       /                                               \    
User_A                 User_B                     ●●●                    User_N 
                                                                                
问题：不同的用户可能登录到不同的服务器上，                                      
      用户A给用户B发消息时，                                                    
      首先判断B是否也登录在本服务器上，是，则直接转发消息即可。                 
      若B不在本服务器上，那应该往哪里转发这条消息呢？                           
                                                                                
~~~

### 2、简单直接分布式架构方案


+ 方案描述：
    * 做法：向服务器集群中的其他服务器广播这条消息，对于每个收到这条消息的服务器，首先判断消息的目的用户是否登录在自己身上，如果不是，直接忽略该消息。如果是，那么向目的用户转发该消息。
    *  优点：暴力粗犷、最简单直接
    * 缺点：
          + 会产生很多无效的消息转发，对于服务器性能产生很大的影响
          + 会加重route server的负载（不同的msg服务器连接到同一台route server上,所有msg服务器之间的转发全部通过route server）
          + 最薄弱的环节：route server系统容量也是有限
    *  改善：
          + 设立一套明确的路由系统（解决服务器之间的消息转发不能直接全部广播，即服务器在转发消息时，应该知道这条消息应该转发到哪一台服务器，这样就不需要每条消息都在所有服务器之间广播了）


~~~                                                                             
                                                                                
服务器架构模型示意图：                                                          
                                                                                
                            ┌──────────────┐                                    
                            │ Route Server │                                    
                            └──────────────┘                                    
                          ╱       │        ╲                                  
                        ╱         │          ╲                                
                      ╱           │            ╲                              
           ┌────────────┐    ┌────────────┐       ┌────────────┐                
           │ Msg Server │    │ Msg Server │  ●●●  │ Msg Server │                
           └────────────┘    └────────────┘       └────────────┘                
          ╱                ╱                                  ╲              
        ╱                ╱                                      ╲            
      ╱                ╱                                          ╲          
    ╱                ╱                                              ╲        
 User_A            User_B                     ●●●                     User_N    
                                                                                
~~~


### 3、优化路由分布式架构方案

+ 方案描述二：
    + 做法：向服务器集群中的其他服务器广播这条消息，对于每个收到这条消息的服务器，首先判断消息的目的用户是否登录在自己身上，如果不是，直接忽略该消息。如果是，那么向目的用户转发该消息。
    + 优点：相对方案2会减少无效的消息转发，降低路由服务


~~~                                                                             

服务器架构模型示意图：                                                          
                                                                                
                            ┌──────────────┐                                    
                            │ Route Server │                                    
                            └──────────────┘                                    
                          ╱       │        ╲                                  
                        ╱         │          ╲                                
                      ╱           │            ╲                              
           ┌────────────┐    ┌────────────┐       ┌────────────┐                
           │ Msg Server │    │ Msg Server │  ●●●  │ Msg Server │                
           └────────────┘    └────────────┘       └────────────┘                
          ╱                ╱                                  ╲              
        ╱                ╱                                      ╲            
      ╱                ╱                                          ╲          
    ╱                ╱                                              ╲        
 User_A            User_B                     ●●●                     User_N    
                                                                                
问题：不同的用户可能登录到不同的服务器上，                                      
      用户A给用户B发消息时，                                                    
      首先判断B是否也登录在本服务器上，是，则直接转发消息即可。                 
      若B不在本服务器上，那应该往哪里转发这条消息呢？                           
                                                                                
~~~


### 3、优化路由分布式架构方案




### 4
~~~
画图基础元件：
                                                                                
            ┌────────────┐                                                      
            │ Msg Server │                                                      
            └────────────┘                                                      
          ╱   ╱  │  ╲   ╲                                                   
        ╱   ╱    │    ╲   ╲                                                 
      ╱   ╱      │      ╲   ╲                                               
    ╱   User_B   ...      ...   ╲                                             
 User_A                          User_N                                         
                                                                                
         +-------------+                                                        
         | Msg Server  |                                                        
         +-------------+                                                        
        /   /   |   \   \                                                      
       /   /    |    \   \                                                     
      /   /     |     \   \                                                    
     / User_B  ...   ...   \                                                   
  User_A                  User_N                                                
                                                                                
注：（文本中画图常用制表符）                                                    
                                                                                
  │ ┤ ├ ─ ┌ ┐ └ ┘ ┴ ┬ ┼                                                         
                                                                                
  ╭ ╮╰ ╯  ╱ ╲ ╱                                                          
                                                                                
  ┝ ┞┟┠┡ ╋ ╬  ╳                                                          
                                                                                
  ⊙ ▲ ▼●◆■★∆ · ∴                                                            
                                                                                
  甴〣𠃎𠃊𠃍丄                                                                  

  槑                                                                            
                                                                                
~~~
> [告诉你电脑上特殊符号怎么打出来？](http://www.360doc.com/content/15/0801/05/805501_488664977.shtml)


## 参考资料
+ [即时通讯基于socket的tcp方式](https://blog.csdn.net/u011706736/article/details/50830843)
+ [(一)即时通讯系列之Socket简介](https://www.jianshu.com/p/94b138362173)
+ [(二)即时通讯系列之TCP Socket](https://www.jianshu.com/p/9029d808e4b6)
+ [Socket即时通讯小实例](https://www.cnblogs.com/BinShao/p/3574280.html)
+ [即时通讯系统架构](http://www.xuebuyuan.com/3190394.html)
+ [即时通信服务器架构的一些思考](https://www.cnblogs.com/myd620/p/6081100.html)
